<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal - GuardianRoute</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        :root { --primary: #4f46e5; --dark: #0f172a; --light: #f8fafc; }
        body { font-family: 'Outfit', sans-serif; margin: 0; background-color: var(--light); color: var(--dark); height: 100vh; display: flex; flex-direction: column; }

        /* --- LOGIN SCREEN --- */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); transition: all 0.3s; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { font-size: 0.9rem; color: #64748b; margin-bottom: 5px; display: block; font-weight: 500; }
        
        input, select { width: 100%; padding: 12px 15px; border: 1px solid #cbd5e1; border-radius: 12px; box-sizing: border-box; font-family: inherit; font-size: 1rem; background: #fff; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #4338ca; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }

        /* Hidden Sections */
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD --- */
        #dashboardScreen { display: none; flex-direction: column; height: 100%; }
        header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .student-card { background: white; margin: 20px; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; background: #e0e7ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .info h3 { margin: 0; font-size: 1.1rem; }
        .info p { margin: 2px 0 0; color: #64748b; font-size: 0.9rem; }
        .status-pill { margin-left: auto; background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        #mapContainer { flex: 1; margin: 0 20px 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; }
        #map { width: 100%; height: 100%; }
        .bus-details { position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-card">
            
            <div class="logo" style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <img src="images/imglogo.png" alt="GuardianRoute Logo" style="height: 50px; margin-right: 1px;"> 
                <b style="font-size: 1.5rem; color: #237355;">GuardianRoute</b>
            </div>

            <h2 id="loginTitle">Parent Login</h2>
            
            <div id="step1">
                <p style="color: #64748b; margin-bottom: 20px;">Enter your registered mobile number.</p>
                <div class="input-group">
                    <label>Mobile Number</label>
                    <input type="tel" id="mobileInput" placeholder="e.g. 7710893839">
                </div>
                <button class="btn" onclick="verifyPhone()">Get Details</button>
                <p style="margin-top: 15px; font-size: 0.8rem; color: #94a3b8;">Try: 9022767450</p>
            </div>

            <div id="step2" class="hidden fade-in">
                <p style="color: #64748b; margin-bottom: 20px;">Select your child to track.</p>
                
                <div class="input-group">
                    <label>Select Student</label>
                    <select id="studentSelect" onchange="autoSelectBus()"></select>
                </div>

                <div class="input-group">
                    <label>Assigned Bus</label>
                    <select id="busSelect" disabled style="background-color: #f1f5f9; cursor: not-allowed;"></select>
                </div>

                <button class="btn" onclick="completeLogin()">Track Bus üìç</button>
                <button class="btn btn-outline" onclick="goBack()">Back</button>
            </div>

        </div>
    </div>

    <div id="dashboardScreen">
        <header>
            <div class="logo">
                <img src="images/imglogo.png" alt="Logo" style="height: 35px; margin-right: 8px; vertical-align: middle;">
                <b style="color: var(--primary); font-size: 1.2rem;">GuardianRoute</b>
            </div>
            <div style="color: #ef4444; font-size: 1.2rem; cursor: pointer;" onclick="logout()"><i class="fas fa-sign-out-alt"></i></div>
        </header>

        <div class="student-card">
            <div class="avatar"><i class="fas fa-user-graduate"></i></div>
            <div class="info">
                <h3 id="dispName">Loading...</h3>
                <p id="dispDetails">Loading...</p>
            </div>
            <div class="status-pill">On Board</div>
        </div>

        <div id="mapContainer">
            <div id="map"></div>
            <div class="bus-details">
                <div>
                    <strong style="display:block; color:#0f172a;" id="dispBusId">Bus --</strong>
                    <span style="font-size:0.85rem; color:#64748b;" id="dispDriver">Driver: --</span>
                </div>
                <div style="text-align: right;">
                    <strong style="display:block; color:#4f46e5;">Live</strong>
                    <span style="font-size:0.85rem; color:#64748b;">Tracking</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io('https://guardianroute-transport-system-n.onrender.com'); 
        let map, busMarker;

        // --- üìä DYNAMIC DATA LOADING (External File) ---
        let schoolData = {}; // Data ab empty hai, file se aayega

        // Page load hote hi data fetch karein
        async function loadStudentData() {
            try {
                // 'students.json' file ko padhein
                const response = await fetch('students.json');
                
                // Agar file nahi mili toh error throw karein
                if (!response.ok) {
                    throw new Error("HTTP error " + response.status);
                }
                
                // JSON data ko variable mein save karein
                schoolData = await response.json();
                console.log("‚úÖ Student Database Loaded");
            } catch (error) {
                console.error("‚ùå Error loading student data:", error);
                alert("Database Error: Make sure 'students.json' file is in the frontend folder!");
            }
        }
        
        // Function run karein
        loadStudentData();

        let selectedStudent = null;

        // --- LOGIC: Step 1 (Verify Phone) ---
        function verifyPhone() {
            const mobile = document.getElementById('mobileInput').value;
            
            // Check karein ki data load hua ya nahi
            if (Object.keys(schoolData).length === 0) {
                alert("‚è≥ Please wait, Database is loading...");
                return;
            }

            if (schoolData[mobile]) {
                const students = schoolData[mobile];
                const studentSelect = document.getElementById('studentSelect');
                studentSelect.innerHTML = "";

                students.forEach((student, index) => {
                    let option = document.createElement("option");
                    option.value = index;
                    option.text = `${student.name} (Class ${student.class})`;
                    studentSelect.appendChild(option);
                });

                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                autoSelectBus();
            } else {
                alert("‚ùå Number not found! Try: 9022767450");
            }
        }

        // --- LOGIC: Auto Select Bus ---
        function autoSelectBus() {
            const mobile = document.getElementById('mobileInput').value;
            const studentIndex = document.getElementById('studentSelect').value;
            const student = schoolData[mobile][studentIndex];
            
            const busSelect = document.getElementById('busSelect');
            busSelect.innerHTML = "";
            
            let option = document.createElement("option");
            option.value = student.busId;
            option.text = `${student.busId} - ${student.driver}`;
            busSelect.appendChild(option);

            selectedStudent = student;
        }

        function goBack() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        // --- LOGIC: Step 2 (Final Login) ---
        function completeLogin() {
            if (!selectedStudent) return;

            document.getElementById('dispName').innerText = selectedStudent.name;
            document.getElementById('dispDetails').innerText = `Class ${selectedStudent.class} | Roll No. ${selectedStudent.roll}`;
            document.getElementById('dispBusId').innerText = selectedStudent.busId;
            document.getElementById('dispDriver').innerText = `Driver: ${selectedStudent.driver}`;

            const mobile = document.getElementById('mobileInput').value;
            socket.emit('parentJoined', { mobile: mobile, student: selectedStudent.name });

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'flex';
            
            setTimeout(() => initMap(selectedStudent.busId), 100);
        }

        function logout() {
            if(confirm("Log out?")) location.reload();
        }

        // --- MAP LOGIC ---
        function initMap(targetBusId) {
            map = L.map('map').setView([19.0760, 72.8777], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'OpenStreetMap',
                maxZoom: 20
            }).addTo(map);

            L.marker([19.0800, 72.8800]).addTo(map).bindPopup("üè† Home");

            const busIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
                iconSize: [45, 45],
                iconAnchor: [22, 22]
            });

            socket.on('updateMap', (data) => {
                const { busId, location } = data;
                
                if (busMarker) {
                    busMarker.setLatLng([location.lat, location.lng]);
                } else {
                    busMarker = L.marker([location.lat, location.lng], { icon: busIcon })
                        .addTo(map)
                        .bindPopup(`<b>${busId}</b><br>Arriving Soon`);
                }
                map.panTo([location.lat, location.lng]);
            });
        }
    </script>

</body>
</html>